<div
  *ngIf="isLoading"
  class="flex flex-col justify-center items-center h-screen text-white text-center"
>
  <mat-progress-spinner
    color="primary"
    mode="indeterminate"
  ></mat-progress-spinner>
  <p class="pt-8">Loading media details...</p>
</div>

<div *ngIf="mediaItem" class="lg:container lg:mx-auto py-8 px-4">
  <button
    [routerLink]="['/gallery']"
    class="mb-8 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center"
  >
    &larr; Back to Gallery
  </button>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column: The Image/Video -->
    <div class="lg:col-span-2">
      <!-- This container will be used by lightGallery to render the inline carousel -->
      <div #lightGalleryCarousel class="inline-gallery-container"></div>
    </div>

    <!-- Right Column: The Metadata -->
    <div class="lg:col-span-1 text-white">
      <h2 class="text-3xl font-bold mb-4">Details</h2>

      <mat-tab-group mat-align-tabs="start" animationDuration="0ms">
        <!-- Generation Details Tab -->
        <mat-tab label="Details">
          <div class="py-4 space-y-6">
            <!-- Prompts Section -->
            <section class="space-y-4">
              <h3
                class="text-lg font-semibold border-b border-gray-700 pb-2"
              >
                Prompts
              </h3>

              <!-- Prompt Used -->
              <mat-expansion-panel class="!bg-gray-800 !text-white">
                <mat-expansion-panel-header>
                  <mat-panel-title class="!font-semibold">
                    Prompt
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <pre
                  class="mt-2 p-3 rounded-md bg-gray-900 text-sm whitespace-pre-wrap break-words text-gray-300"
                  >{{ formattedPrompt }}</pre
                >
              </mat-expansion-panel>

              <!-- Other Prompts -->
              <div class="text-sm space-y-3">
                <div *ngIf="mediaItem.original_prompt">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >Original Prompt:</strong
                  >
                  <p class="p-3 rounded-md bg-gray-800 text-gray-300">
                    {{ mediaItem.original_prompt }}
                  </p>
                </div>
                <div *ngIf="mediaItem.rewritten_prompt">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >Rewritten Prompt:</strong
                  >
                  <p class="p-3 rounded-md bg-gray-800 text-gray-300">
                    {{ mediaItem.rewritten_prompt }}
                  </p>
                </div>
                <div *ngIf="mediaItem.negative_prompt">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >Negative Prompt:</strong
                  >
                  <p class="p-3 rounded-md bg-gray-800 text-gray-300">
                    {{ mediaItem.negative_prompt }}
                  </p>
                </div>
              </div>
            </section>

            <!-- Parameters Section -->
            <section class="space-y-3">
              <h3
                class="text-lg font-semibold border-b border-gray-700 pb-2"
              >
                Parameters
              </h3>
              <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <strong class="font-semibold text-gray-400">Model:</strong>
                <p class="text-right break-all">
                  {{ mediaItem.model || 'N/A' }}
                </p>

                <strong class="font-semibold text-gray-400">Creator:</strong>
                <p class="text-right break-all">
                  {{ mediaItem.user_email || 'N/A' }}
                </p>

                <strong class="font-semibold text-gray-400"
                  >Created At:</strong
                >
                <p class="text-right">
                  {{ mediaItem.created_at | date: 'medium' }}
                </p>

                <div *ngIf="mediaItem.generation_time" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Generation Time:</strong
                  >
                  <p class="text-right">
                    {{ mediaItem.generation_time | number: '1.0-2' }}s
                  </p>
                </div>

                <div *ngIf="mediaItem.seed" class="contents">
                  <strong class="font-semibold text-gray-400">Seed:</strong>
                  <p class="text-right">{{ mediaItem.seed }}</p>
                </div>

                <div *ngIf="mediaItem.num_media" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Number of Media:</strong
                  >
                  <p class="text-right">{{ mediaItem.num_media }}</p>
                </div>

                <div *ngIf="mediaItem.duration" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Duration:</strong
                  >
                  <p class="text-right">{{ mediaItem.duration }}s</p>
                </div>

                <div
                  *ngIf="mediaItem.aspect_ratio || mediaItem.aspect"
                  class="contents"
                >
                  <strong class="font-semibold text-gray-400"
                    >Aspect Ratio:</strong
                  >
                  <p class="text-right">
                    {{ mediaItem.aspect_ratio || mediaItem.aspect }}
                  </p>
                </div>
              </div>
            </section>

            <!-- Style Section -->
            <section
              class="space-y-3"
              *ngIf="
                mediaItem.style ||
                mediaItem.lighting ||
                mediaItem.color_and_tone ||
                mediaItem.composition ||
                mediaItem.modifiers?.length
              "
            >
              <h3
                class="text-lg font-semibold border-b border-gray-700 pb-2"
              >
                Style
              </h3>
              <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div *ngIf="mediaItem.style" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Image Style:</strong
                  >
                  <p class="text-right">{{ mediaItem.style }}</p>
                </div>
                <div *ngIf="mediaItem.lighting" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Lighting:</strong
                  >
                  <p class="text-right">{{ mediaItem.lighting }}</p>
                </div>
                <div *ngIf="mediaItem.color_and_tone" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Color & Tone:</strong
                  >
                  <p class="text-right">{{ mediaItem.color_and_tone }}</p>
                </div>
                <div *ngIf="mediaItem.composition" class="contents">
                  <strong class="font-semibold text-gray-400"
                    >Composition:</strong
                  >
                  <p class="text-right">{{ mediaItem.composition }}</p>
                </div>
              </div>
              <div *ngIf="mediaItem.modifiers?.length" class="pt-2">
                <strong
                  class="font-semibold text-gray-400 mb-2 block text-sm"
                  >Modifiers:</strong
                >
                <mat-chip-listbox aria-label="Style modifiers">
                  <mat-chip-option
                    *ngFor="let modifier of mediaItem.modifiers"
                    class="!bg-gray-700 !text-gray-300"
                    >{{ modifier }}</mat-chip-option
                  >
                </mat-chip-listbox>
              </div>
            </section>
          </div>
        </mat-tab>

        <!-- Technical Info Tab -->
        <mat-tab label="Technical">
          <div class="py-4 space-y-6">
            <!-- File Info -->
            <section class="space-y-3">
              <h3
                class="text-lg font-semibold border-b border-gray-700 pb-2"
              >
                File Info
              </h3>
              <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <strong class="font-semibold text-gray-400"
                  >Mime Type:</strong
                >
                <p class="text-right">{{ mediaItem.mime_type || 'N/A' }}</p>

                <strong class="font-semibold text-gray-400"
                  >Watermark:</strong
                >
                <p class="text-right">
                  {{ mediaItem.add_watermark ?? 'N/A' }}
                </p>
              </div>
            </section>

            <!-- Storage -->
            <section class="space-y-3">
              <h3
                class="text-lg font-semibold border-b border-gray-700 pb-2"
              >
                Storage
              </h3>
              <div class="text-sm space-y-3">
                <div *ngIf="mediaItem.gcsuri">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >GCS URI:</strong
                  >
                  <a
                    [href]="getGcsLink(mediaItem.gcsuri)"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="p-3 rounded-md bg-gray-800 block break-all hover:bg-gray-700 transition-colors"
                  >
                    {{ mediaItem.gcsuri }}
                  </a>
                </div>
                <div *ngIf="mediaItem.gcs_uris?.length">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >GCS URIs:</strong
                  >
                  <ul class="space-y-1">
                    <li *ngFor="let uri of mediaItem.gcs_uris">
                      <a
                        [href]="getGcsLink(uri)"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="p-3 rounded-md bg-gray-800 block break-all hover:bg-gray-700 transition-colors"
                      >
                        {{ uri }}
                      </a>
                    </li>
                  </ul>
                </div>
                <div *ngIf="mediaItem.source_images_gcs?.length">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >Source Images:</strong
                  >
                  <ul class="space-y-1">
                    <li *ngFor="let image of mediaItem.source_images_gcs">
                      <a
                        [href]="getGcsLink(image)"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="p-3 rounded-md bg-gray-800 block break-all hover:bg-gray-700 transition-colors"
                      >
                        {{ image }}
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </section>

            <!-- Other -->
            <section class="space-y-3">
              <h3
                class="text-lg font-semibold border-b border-gray-700 pb-2"
              >
                Other
              </h3>
              <div class="text-sm space-y-3">
                <div *ngIf="mediaItem.comment">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >Comment:</strong
                  >
                  <p class="p-3 rounded-md bg-gray-800 text-gray-300">
                    {{ mediaItem.comment }}
                  </p>
                </div>
                <div *ngIf="mediaItem.critique">
                  <strong class="font-semibold text-gray-400 block mb-1"
                    >Critique:</strong
                  >
                  <p class="p-3 rounded-md bg-gray-800 text-gray-300">
                    {{ mediaItem.critique }}
                  </p>
                </div>
              </div>
            </section>
          </div>
        </mat-tab>

        <!-- Debug Tab -->
        <mat-tab
          label="Debug"
          *ngIf="
            mediaItem.raw_data ||
            mediaItem.audio_analysis ||
            mediaItem.error_message
          "
        >
          <div class="py-4 space-y-4">
            <div *ngIf="mediaItem.error_message">
              <strong class="font-semibold text-red-400 block mb-1"
                >Error Message:</strong
              >
              <p class="p-3 rounded-md bg-red-900/50 text-red-300">
                {{ mediaItem.error_message }}
              </p>
            </div>

            <mat-expansion-panel
              *ngIf="mediaItem.raw_data"
              class="!bg-gray-800 !text-white"
            >
              <mat-expansion-panel-header>
                <mat-panel-title class="!font-semibold">
                  Raw Data
                </mat-panel-title>
              </mat-expansion-panel-header>
              <pre
                class="mt-2 p-3 rounded-md bg-gray-900 text-sm whitespace-pre-wrap break-words text-gray-300"
                >{{ mediaItem.raw_data | json }}</pre
              >
            </mat-expansion-panel>

            <mat-expansion-panel
              *ngIf="mediaItem.audio_analysis"
              class="!bg-gray-800 !text-white"
            >
              <mat-expansion-panel-header>
                <mat-panel-title class="!font-semibold">
                  Audio Analysis
                </mat-panel-title>
              </mat-expansion-panel-header>
              <pre
                class="mt-2 p-3 rounded-md bg-gray-900 text-sm whitespace-pre-wrap break-words text-gray-300"
                >{{ mediaItem.audio_analysis | json }}</pre
              >
            </mat-expansion-panel>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>
